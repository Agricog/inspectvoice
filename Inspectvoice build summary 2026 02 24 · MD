# InspectVoice — Master Build Reference

**Last updated:** 26 February 2026
**Status:** 15 features built, backend deployed, auth working, CI/CD operational
**GitHub repo:** `https://github.com/Agricog/inspectvoice`

---

## 1. WHAT INSPECTVOICE IS

InspectVoice is a voice-driven, AI-assisted inspection platform for UK parks, playgrounds, and outdoor recreation assets. It eliminates 1–2 hours of post-inspection admin per site by converting voice dictation into BS EN 1176/1177-compliant inspection reports.

**How it works:** An inspector walks a site, taps each asset on their phone, speaks observations. The system transcribes via Speechmatics, analyses against BS EN standards via Claude, and returns structured defect data with risk ratings, BS EN section references, remedial actions, cost bands, and action timeframes. The inspector reviews, confirms or overrides, signs off, and a professional PDF is generated.

**Three inspection types (per BS EN 1176-7:2020):**
- **Routine Visual** — daily/weekly walk-around, quick hazard check (~15 min)
- **Operational** — 1–3 monthly functional testing, wear assessment (~1 hour)
- **Annual Main** — comprehensive engineering inspection, full compliance audit (~3 hours)

**Business model:** Multi-tenant SaaS with Stripe billing. Team £149/mo, Enterprise £349/mo. Target: independent RoSPA/RPII inspectors, council parks departments, playground maintenance companies. Competitors: iCertifi (market leader, iOS only), Tradecert (AI observation wording), Pro Certs, EasyCert — **none offer voice-first capture.**

---

## 2. TECH STACK

| Layer | Technology |
|---|---|
| Frontend | React 18.3.1 + TypeScript strict + Vite + Tailwind CSS |
| Backend | Cloudflare Workers (`inspectvoice-api`) |
| Database | Neon PostgreSQL (AWS eu-west-2 London) |
| Storage | Cloudflare R2 (`inspectvoice-storage`) |
| Auth | Clerk (JWT + webhooks, RBAC, multi-tenancy) |
| STT | Speechmatics Batch API (EU, enhanced model) + Web Speech API (fallback) |
| AI | Anthropic Claude Sonnet 4 |
| Queues | Cloudflare Queues (audio processing, PDF generation) |
| PDF | pdf-lib (not jspdf) |
| Maps | Mapbox GL JS v3 + react-map-gl (route planning) |
| Email | Resend + React Email (scheduled digests) |
| Rate Limiting | Upstash Redis (tenant-scoped) |
| Frontend Hosting | Railway (auto-deploy on push to `main`) |
| Payments | Stripe (subscription webhooks) |
| Error Tracking | Sentry (with PII scrubbing) |

---

## 3. BUILD STANDARD (Autaimate v3 — non-negotiable)

- TypeScript strict mode with `noUncheckedIndexedAccess` — zero `any`
- Every file ships production-ready first time — no rework passes
- Server-side validation on all endpoints (Zod schemas)
- Multi-tenancy: `org_id` on every table, RLS policies, server-side enforcement
- RBAC via Clerk org roles, enforced at API level
- Offline-first: IndexedDB queue-and-sync, graceful degradation
- Audit logging: requestId, userId, orgId, timestamp on all state changes
- DOMPurify sanitisation on all user input
- SSRF protection: fetch locked to `VITE_API_BASE_URL` origin
- CSRF tokens on all state-changing requests
- Sentry PII scrubbing (auth headers, cookies, URL tokens)
- Signed inspections are immutable — no backward state transitions
- pdf-lib only — never jspdf
- Dark theme only — design tokens (`iv-text`, `iv-muted`, `iv-surface`)
- Path aliases: `@/`, `@components/`, `@pages/`, `@hooks/`, `@services/`, `@utils/`, `@types/`, `@config/`
- Mick works via GitHub web interface only — no terminal/CLI
- **When modifying existing files, always upload the current version from GitHub first — never guess or reconstruct**

### Design System
- Dark theme: bg `#0C0F14`, surface `#151920`, accent `#22C55E`
- Risk colours: very-high `#EF4444`, high `#F97316`, medium `#EAB308`, low `#22C55E`
- Fonts: Inter (UI), JetBrains Mono (code/data)
- Mobile-first responsive
- Component classes: `iv-btn-primary`, `iv-btn-secondary`, `iv-btn-icon`, `iv-panel`, `iv-badge`, `iv-input`, `iv-select`, `iv-label`, `iv-card`, `iv-card-interactive`

---

## 4. ARCHITECTURE

```
Browser → Railway (React 18 + TypeScript + Vite + Tailwind CSS frontend)
  ↓ Clerk sign-in (ClerkProvider → AuthTokenProvider → AuthGate → OrgGate)
  ↓ JWT in Authorization header (v2 format, org claims in o.id)
  ↓
Cloudflare Worker (inspectvoice-api)
  ↓ guard.ts: verify JWT via JWKS, validate issuer + azp, extract org_id
  ↓ RequestContext: { userId, orgId, userRole, requestId }
  ↓
Route handlers → Neon PostgreSQL (via @neondatabase/serverless)
  ↓
R2 bucket (photos, audio, sealed-exports/{org_id}/{bundle_id}.zip)
Queues (inspectvoice-audio-processing, inspectvoice-pdf-generation + DLQs)
Cron Triggers (08:00 UTC summary emails, 03:00 UTC metrics computation)
  ↓
Speechmatics (transcription) → Claude API (AI analysis + normalisation)
Resend API (email delivery)
Mapbox API (route optimisation + directions — server-side only)
```

### Key Architectural Decisions

**Inspection State Machine:** `DRAFT → REVIEW → SIGNED → EXPORTED` — once SIGNED, immutable (enforced at DB trigger level). No backward transitions.

**AI Pipeline:** Voice → Speechmatics (transcription) → Claude Sonnet (BS EN analysis) → Structured JSON. Async via Cloudflare Queues. Inspector reviews and confirms (maintains liability).

**Multi-tenancy:** Server-side only. Every API endpoint validates Clerk JWT, derives tenantId from org claims. RLS in Neon PostgreSQL. Frontend never trusted with tenant filtering.

**Offline-First:** All inspection data captured to IndexedDB first. Background sync when online. Inspections never block on connectivity. Last write wins for drafts, immutable once signed.

**Clerk v2 JWT Format:**
```json
{
  "sub": "user_xxx",
  "o": { "id": "org_xxx", "rol": "admin", "slg": "inspectvoice-xxx" },
  "v": 2
}
```
Guard supports both v1 (flat `org_id`/`org_role`) and v2 (nested `o` object).

---

## 5. REPOSITORY STRUCTURE

```
inspectvoice/
├── .github/workflows/deploy-worker.yml
├── migrations/
│   ├── 001_initial_schema.sql          # 10 core tables, 22 indexes, 5 RLS, 8 triggers
│   ├── 002_make_safe.sql               # Feature 2: asset_safety_actions
│   ├── 003_baseline_photos.sql         # Feature 5: baseline columns + history
│   ├── 004_incidents.sql               # Feature 9: incidents (40+ columns)
│   ├── 005_sealed_exports.sql          # Feature 10: immutable sealed exports
│   ├── 006_email_preferences.sql       # Feature 11: email_preferences + send_log
│   ├── 007_normalisation.sql           # Feature 12: normalisation_log + usage
│   ├── 008_site_assignments.sql        # Feature 13: site_assignments (RBAC)
│   └── 009_inspector_performance_and_defect_library.sql  # F14+F15: 4 tables
│
├── src/                                # Frontend (React/Vite)
│   ├── main.tsx                        # Entry — ClerkProvider + AuthTokenProvider + Sentry
│   ├── App.tsx                         # Routes — AuthGate, OrgGate, all page routes
│   ├── index.css                       # Tailwind + component library + design tokens
│   ├── mapbox-gl.d.ts                  # Type stub for phantom @mapbox/point-geometry
│   ├── vite-env.d.ts
│   ├── components/
│   │   ├── Layout.tsx                  # App shell — header, nav (incl F14+F15 links), offline banner, footer
│   │   ├── AuthTokenProvider.tsx       # Clerk token bridge (renders nothing)
│   │   ├── BaselineComparison.tsx      # F5: Before/after slider
│   │   ├── CompletenessCheckModal.tsx  # F4: Review gate modal
│   │   ├── DefectExportButton.tsx      # F1+F10: Export UI with sealed option
│   │   ├── DefectQuickPick.tsx         # F15: Bottom-sheet defect picker during capture
│   │   ├── DefectTracker.tsx           # F2: Make Safe integration
│   │   ├── EmailPreferences.tsx        # F11: Email settings panel
│   │   ├── MakeSafeModal.tsx           # F2: Safety action modal
│   │   ├── NormaliseButton.tsx         # F12: Per-field inline normalise
│   │   ├── NormalisationReviewPanel.tsx # F12: Batch diff review modal
│   │   ├── NormalisationSettings.tsx   # F12: Admin style config
│   │   ├── PerformanceDashboardSection.tsx # F14: Org stats + My Performance cards for dashboard
│   │   ├── PWAUpdatePrompt.tsx         # PWA update notification
│   │   ├── SealedExportButton.tsx      # F10: Sealed export trigger
│   │   └── VerificationBadge.tsx       # F10: Seal status display
│   ├── config/
│   │   ├── index.ts
│   │   ├── complianceStandards.ts      # BS EN 1176/1177/16630 reference
│   │   └── assetTypes.ts              # 16 asset type configs
│   ├── hooks/
│   │   ├── useDefectLibrary.ts        # F15: Quick-pick fetch, usage recording, library search
│   │   ├── useFetch.ts                # SSRF + CSRF + throttle + retry + Bearer auto-inject
│   │   ├── useFormValidation.ts
│   │   ├── useSessionTimeout.ts
│   │   └── useOnlineStatus.ts
│   ├── pages/
│   │   ├── AssetDetail.tsx            # F8: Rewrite with condition timeline + history
│   │   ├── AssetForm.tsx              # Create/edit equipment
│   │   ├── DefectLibraryPage.tsx      # F15: Manager library management UI
│   │   ├── DefectTracker.tsx          # Defect tracker dashboard
│   │   ├── IncidentForm.tsx           # F9: 8-section incident form
│   │   ├── IncidentList.tsx           # F9: Filterable incident register
│   │   ├── InspectionCapture.tsx      # F5+F15: Core capture + baseline + defect quick-pick
│   │   ├── InspectionList.tsx         # All inspections, filter by status/type/date
│   │   ├── InspectionReview.tsx       # F4+F12: Sign-off + normalisation
│   │   ├── InspectionStart.tsx        # Select type, weather, asset register
│   │   ├── InspectorDetailPage.tsx    # F14: KPI cards + trend sparklines + benchmarks
│   │   ├── InspectorPerformancePage.tsx # F14: Manager overview table (sortable, filterable)
│   │   ├── ManagerDashboard.tsx       # F7+F14: Hotlist + PerformanceDashboardSection
│   │   ├── MyPerformancePage.tsx      # F14: Inspector own stats wrapper + embeddable card
│   │   ├── NormalisationHistoryPage.tsx # F12: Usage stats + log
│   │   ├── PerformanceSharePage.tsx   # F14: Public token-based "Your Month" view (no auth)
│   │   ├── RoutePlanner.tsx           # F13: Mapbox GL map + route optimisation
│   │   ├── SealedExportsPage.tsx      # F10: Sealed exports list
│   │   ├── SettingsPage.tsx           # F12: NormalisationSettings wired in
│   │   ├── SiteDetail.tsx             # Site info + asset register + inspections
│   │   ├── SiteForm.tsx               # Create/edit site
│   │   ├── SiteList.tsx               # Search, filter, sort sites
│   │   └── VerifyPage.tsx             # F10: Public verification
│   ├── services/
│   │   ├── defectExport.ts            # F1: Client-side Excel export (offline)
│   │   ├── offlineStore.ts            # IndexedDB 7 stores, sync queue, size guards
│   │   ├── pdfGenerator.ts            # F3: Client PDF with evidence log
│   │   ├── photoCoverage.ts           # F3: Photo validation + cross-refs
│   │   ├── photoCapture.ts            # Camera, compression, thumbnails, EXIF GPS
│   │   ├── sealedExport.ts            # F10: Client-side sealed export helpers
│   │   ├── syncService.ts             # Background sync engine (FIFO, backoff, R2)
│   │   └── voiceCapture.ts            # Web Speech API + MediaRecorder
│   ├── types/
│   │   ├── index.ts                   # Barrel export
│   │   ├── entities.ts                # All entity interfaces (1:1 with Neon schema)
│   │   ├── enums.ts                   # 25+ enums with label/description maps
│   │   ├── features14_15.ts           # F14+F15: Metrics, benchmarks, library, quick-pick types
│   │   ├── normalisation.ts           # F12: Full normalisation type definitions
│   │   └── offline.ts                 # IndexedDB wrapper types, sync queue types
│   └── utils/
│       ├── analytics.ts               # Privacy-respecting event tracking
│       ├── authToken.ts               # Clerk token bridge (module-level getter/setter)
│       ├── csrf.ts                    # CSRF token management
│       ├── errorTracking.ts           # Sentry init with PII scrubbing
│       ├── sanitization.ts            # DOMPurify wrappers
│       └── validation.ts              # Validation framework + domain validators
│
├── workers/                           # Backend (Cloudflare Workers)
│   ├── package.json                   # wrangler v4, fflate, xlsx, resend, @react-email
│   ├── tsconfig.json
│   ├── wrangler.toml                  # R2 bindings, queues, 2 cron triggers, vars
│   └── src/
│       ├── index.ts                   # Main router — all feature routes + verify/share before auth
│       ├── types.ts                   # Env interface (all secrets), ClerkJwtPayload (v1+v2)
│       ├── cron/
│       │   └── metricsComputation.ts  # F14: Daily 03:00 UTC metrics aggregation per inspector
│       ├── data/
│       │   └── defectLibrarySeed.ts   # F15: 50 seed defects across 16 asset types
│       ├── middleware/
│       │   ├── cors.ts
│       │   ├── csrf.ts
│       │   ├── guard.ts               # Clerk JWT verification, v1+v2, issuer/azp validation
│       │   └── rateLimit.ts           # Upstash Redis
│       ├── queues/
│       │   ├── audioProcessor.ts      # Speechmatics → Claude → batch defect INSERT
│       │   └── pdfGenerator.ts        # Server-side PDF generation queue consumer
│       ├── routes/
│       │   ├── webhooks/
│       │   │   ├── clerk.ts
│       │   │   └── stripe.ts
│       │   ├── assets.ts
│       │   ├── assetHistory.ts        # F8: 4 parallel queries
│       │   ├── claimsPack.ts          # F9: 9 parallel queries
│       │   ├── completenessCheck.ts   # F4: 10 deterministic checks
│       │   ├── dashboard.ts           # F7: 5 parallel queries + hotlist
│       │   ├── defectExport.ts        # F1: Server-side Excel
│       │   ├── defectLibrary.ts       # F15: 9 endpoints — CRUD, quick-pick, versioning, seed
│       │   ├── defects.ts
│       │   ├── emailCron.ts           # F11: Cron trigger handler
│       │   ├── emailPreferences.ts    # F11: GET/PATCH preferences
│       │   ├── emailUnsubscribe.ts    # F11: Token-based unsubscribe (no auth)
│       │   ├── helpers.ts
│       │   ├── incidents.ts           # F9: CRUD
│       │   ├── inspectionItems.ts
│       │   ├── inspections.ts
│       │   ├── inspectorPerformance.ts # F14: 7 endpoints — overview, detail, my-stats, benchmarks, share links
│       │   ├── normalise.ts           # F12: field/batch/usage/accept-reject
│       │   ├── org.ts
│       │   ├── pdf.ts                 # BS EN inspection schedule table
│       │   ├── routePlanner.ts        # F13: sites/optimise/directions
│       │   ├── safetyActions.ts       # F2: Make Safe/Close endpoints
│       │   ├── sealedExport.ts        # F10: 5 sealed export endpoints
│       │   ├── sites.ts
│       │   ├── uploads.ts
│       │   ├── users.ts
│       │   └── verify.ts             # F10: Public verification (no auth)
│       ├── services/
│       │   ├── ai.ts                  # Claude prompt with BS EN context
│       │   ├── audit.ts
│       │   ├── db.ts
│       │   ├── emailSender.ts         # F11: Resend API wrapper
│       │   ├── emailTemplates.tsx      # F11: React Email TSX templates
│       │   ├── excelGenerator.ts      # F10: Server-side Excel (SheetJS)
│       │   ├── idempotency.ts
│       │   ├── normalise.ts           # F12: Claude API normalisation service
│       │   ├── pdf.ts                 # F3: Worker PDF with evidence log
│       │   ├── r2.ts
│       │   ├── sealedExport.ts        # F10: Core sealing service
│       │   └── speechmatics.ts        # EU batch API, 60+ term custom dictionary
│       └── shared/
│           ├── errors.ts
│           ├── logger.ts
│           ├── pagination.ts
│           └── validation.ts          # validateRequiredString + Zod helpers
│
├── procurement-pack/                  # Feature 6: 9 council tender documents
│   ├── InspectVoice-DPIA-v1.0.docx
│   ├── InspectVoice-DPA-v1.0.docx
│   ├── InspectVoice-Security-Controls-v1.0.docx
│   ├── InspectVoice-Technical-Spec-SLA-v1.0.docx
│   ├── InspectVoice-Commercial-Terms-v1.0.docx
│   ├── InspectVoice-Training-Migration-Guide-v1.0.docx
│   ├── InspectVoice-Asset-Import-Template.xlsx
│   ├── InspectVoice-Site-Import-Template.xlsx
│   └── InspectVoice-SAMPLE-Defect-Export.xlsx
│
├── index.html
├── package.json                       # Frontend deps
├── tsconfig.json                      # "types": [] for phantom @types prevention
├── tsconfig.node.json
├── vite.config.ts
├── tailwind.config.ts
├── postcss.config.js
└── .eslintrc.cjs
```

---

## 6. DATABASE SCHEMA (Neon — all 21 tables deployed ✅)

### Migration 001: Core Schema (10 tables)

**organisations** — Clerk org sync, Stripe billing, branding, settings JSONB, accreditation
- PK: `id` (UUID), unique `org_id` (TEXT — Clerk org_xxx)
- Stripe: customer_id, subscription_id, status (trialing/active/past_due/cancelled/unpaid/incomplete/expired), plan, period_end, trial_ends_at
- Settings JSONB: default_inspection_type, require_manager_approval, auto_export_on_sign
- Branding: logo_url, primary_color (#22C55E default)

**users** — Clerk user sync, inspector credentials
- PK: `id` (TEXT — Clerk user_xxx), FK to organisations(org_id)
- Inspector: rospa_certification_number, rpii_number, rpii_grade, other_qualifications
- Insurance: provider, policy_number
- Role: inspector/manager/admin
- Status: is_active, deactivated_at, last_login_at

**sites** — Inspection locations
- PK: `id` (UUID), FK to organisations(org_id)
- Location: name, site_code, address, postcode, lat/lng
- Type: playground/park/outdoor_gym/muga/skate_park/sports_pitch/mixed
- Contact: name, phone, email
- Access: notes, opening_hours JSONB, parking_notes
- Compliance: install_date, last_refurbishment_date, inspection_frequency_routine_days (7), inspection_frequency_operational_days (90), inspection_frequency_annual_days (365)
- Financial: total_asset_value_gbp, maintenance_contract_ref
- Status: active/archived/temporary_closure

**assets** — Equipment register per site
- PK: `id` (UUID), FK to sites(id) CASCADE, FK to organisations(org_id)
- Unique constraint: (site_id, asset_code)
- Identification: asset_code, asset_type, asset_category (playground/outdoor_gym/furniture/sports/other)
- Manufacturer: name, model, serial_number, install_date, purchase_cost_gbp
- Compliance: compliance_standard, expected_lifespan_years
- Playground-specific: surface_type (wetpour/rubber_mulch/bark_mulch/grass/sand/artificial_grass/tarmac/concrete/other), fall_height_mm, impact_attenuation_required_mm
- Condition tracking: last_inspection_date, last_inspection_condition (good/fair/poor/dangerous), condition_trend (improving/stable/deteriorating)
- Baseline photo columns (Migration 003): baseline_photo_url, baseline_photo_r2_key, baseline_photo_taken_at, baseline_photo_taken_by, baseline_photo_inspection_id, baseline_condition

**inspections** — Inspection records
- PK: `id` (UUID), FK to organisations(org_id), sites(id), users(id)
- Type: routine_visual/operational/annual_main/post_repair/ad_hoc
- Status: draft/review/signed/exported (state machine, DB immutability trigger)
- Risk summary: overall_risk_rating, very_high/high/medium/low counts, total_defects
- Closure: closure_recommended, closure_reason, immediate_action_required
- Signature: signed_by, signed_at, signature_ip_address (immutable once set)
- Export: pdf_url, pdf_generated_at

**inspection_items** — One per asset inspected
- PK: `id` (UUID), FK to inspections(id) CASCADE
- Voice: audio_r2_key, voice_transcript, transcription_method (deepgram/web_speech_api/manual)
- AI: ai_analysis JSONB, ai_model_version, ai_processing_status (pending/processing/completed/failed)
- Assessment: overall_condition, risk_rating, requires_action, action_timeframe
- Inspector review: inspector_confirmed, inspector_notes, inspector_risk_override

**photos** — Inspection evidence
- PK: `id` (UUID), FK to inspection_items(id) CASCADE
- Storage: r2_key, r2_url, thumbnail_r2_key, thumbnail_r2_url
- File: size_bytes, mime_type, width, height
- Type: defect/overview/reference/completion

**defects** — Normalised from AI analysis
- PK: `id` (UUID), FK to inspection_items(id) CASCADE
- Auto-populated by trigger: org_id, site_id, asset_id (from inspection chain)
- Detail: description, defect_category, bs_en_reference
- Severity: very_high/high/medium/low
- Status: open/assigned/in_progress/resolved/verified/deferred/not_actioned
- Source: ai/manual
- Assignment: assigned_to, assigned_at
- Costs: estimated_cost_gbp (TEXT), actual_cost_gbp (NUMERIC)
- Timeline: due_date, started_at, resolved_at, verified_at, verified_by
- Completion: resolution_notes, completion_photo_ids TEXT[]

**audit_log** — All state changes
- org_id, user_id, action, entity_type, entity_id, changes JSONB, ip, user_agent, timestamp

**webhook_events** — Idempotency for Stripe + Clerk
- Composite PK: (id, source), status: processing/completed/failed

### Schema Features
- 22 indexes on key query paths
- 5 RLS tenant isolation policies (sites, assets, inspections, defects, audit_log)
- 31 CHECK constraints matching `enums.ts` values
- 8 triggers: 6 updated_at, 1 signed inspection immutability, 1 auto-populate defect context
- All org_id columns are TEXT (Clerk uses string IDs, not Postgres UUIDs)

### Migrations 002–009 (Feature tables)

| Migration | Table(s) | Feature |
|-----------|----------|---------|
| 002 | `asset_safety_actions` | F2: Make Safe/Close with RLS, status enum, evidence fields |
| 003 | 6 columns on `assets` + `asset_baseline_history` | F5: Baseline photo comparison |
| 004 | `incidents` | F9: 40+ columns, RIDDOR/HSE/police/insurer refs, 7 indexes, RLS |
| 005 | `sealed_exports` | F10: Immutable records, hash chain, signing_key_id, 4 indexes |
| 006 | `email_preferences` + `email_send_log` | F11: Frequency, timezone, unsubscribe token |
| 007 | `normalisation_log` + `normalisation_usage` | F12: Per-field audit trail, monthly token tracking |
| 008 | `site_assignments` | F13: RBAC site-to-inspector assignment, unique constraint |
| 009 | `inspector_metrics_period` + `performance_share_links` + `defect_library_entry` + `defect_library_entry_version` + `defect_field_audit` | F14+F15: Precomputed metrics, share tokens, versioned library with audit |

**⚠️ Note:** Migration 009 was originally built as `007_inspector_performance_and_defect_library.sql` — rename to `009` before running in Neon to avoid conflicting with the existing 007 (normalisation).

---

## 7. FRONTEND DETAIL (Batches 1–17 + 20 + Features 14–15)

### Batches 1–9: Foundation + Security + Site Management
Project scaffold, Tailwind config, design tokens, security hooks (SSRF, CSRF, session timeout), IndexedDB offline store (7 stores), validation framework, DOMPurify sanitisation, Sentry error tracking, site CRUD pages.

### Batch 10: Asset Form + Asset Detail
`AssetForm.tsx` (1,027 lines) — category→type cascade, auto-populated compliance standards, playground-specific fields, full validation, offline-first save. `AssetDetail.tsx` — asset info, inspection history, condition trend.

### Batch 11: Inspection Start Flow
`InspectionStart.tsx` — select inspection type, weather/surface conditions, load asset register, create draft in IndexedDB.

### Batch 12: Voice Capture Service
`voiceCapture.ts` — Web Speech API (live transcript) + MediaRecorder (audio blob) + silence detection + auto-stop + browser capability detection + graceful degradation.

### Batch 13: Photo Capture Service
`photoCapture.ts` — camera access, JPEG compression, thumbnail generation, base64 storage, EXIF GPS extraction.

### Batch 14: Inspection Capture Workflow
`InspectionCapture.tsx` (1,302 lines) — asset stepper with progress dots, voice recording with VU meter, photo capture with thumbnails, checklist per inspection cadence, condition rating buttons, manual notes, defect quick-pick from library (Feature 15), per-asset IndexedDB save, resume support.

### Batch 15: Inspection Review + Sign-Off
`InspectionReview.tsx` (765 lines) — 4-card risk summary, 3-card key figures, expandable per-asset results, inspector summary (5000 char), closure recommendation, digital sign-off, immutability enforcement.

### Batch 16: PDF Generation
`pdfGenerator.ts` (1,395 lines) — professional BS EN 1176 report via pdf-lib. Cover page, executive summary, asset results, defect register, sign-off section, "Page X of Y" footers.

### Batch 17: Sync Service
`syncService.ts` (697 lines) — singleton, FIFO queue processing, R2 upload (signed URLs), exponential backoff (2s→60s cap, 3 max attempts), 4xx non-retryable, storage maintenance every 30 min.

### Batch 20: Remaining UI Pages (verified complete)
`InspectionList.tsx`, `DefectTracker.tsx`, `ManagerDashboard.tsx`, `SettingsPage.tsx` — all fully built, zero stubs.

### Feature 14: Inspector Performance & Quality Insights (7 frontend files)
**InspectorPerformancePage.tsx** — Manager overview table with sortable columns (inspections, completeness, overdue rate, sign-off time, photo compliance, evidence quality, make-safe, rework, audit flags). Period filter bar (Last 7 Days, Month, Quarter, YTD, Rolling 90, Custom), inspection type filter, summary cards. Row click → drill-in. "Share Your Month" action per inspector.

**InspectorDetailPage.tsx** — KPI cards with trend sparklines (6-month) and benchmark band indicators (top 25%/middle/bottom 25%). Breakdown by inspection type. Used for both manager drill-in and self-view.

**MyPerformancePage.tsx** — Thin wrapper with `isSelf=true`. Exports `MyPerformanceCard` component for dashboard embedding (compact 4-metric card).

**PerformanceDashboardSection.tsx** — Drop-in for ManagerDashboard. Shows org-wide quick stats (managers) + My Performance card (all members). Grid layout.

**PerformanceSharePage.tsx** — Public route `/performance-share/:token`. Token-scoped, read-only, single inspector's data. 30-day expiry. Branded with InspectVoice + Autaimate footer. `noindex, nofollow`.

15 metrics tracked: inspections_completed, completeness_avg, defects_total, defects_per_inspection_avg, photo_compliance_pct, normalisation_accept_rate, avg_time_to_signoff_seconds, overdue_rate, makesafe_initiated/completed, rework_rate, critical_response_avg_seconds, evidence_quality_pct, completeness_variance, audit_flag_count.

RBAC: managers/admins see org-wide overview; inspectors see only own stats via `/my-performance`; benchmarks anonymised for inspectors.

### Feature 15: Defect Library (5 frontend files)
**DefectLibraryPage.tsx** — Manager library management. Filter bar (asset type, source system/org, search). Table with severity badges, usage counts, actions. Create/edit form (org entries only, system read-only). Version history drawer (right-side slide-out). Seed button (admin only, idempotent). Pagination (20/page).

**DefectQuickPick.tsx** — Bottom-sheet component used in InspectionCapture. Filtered by current asset type, shows top entries by usage count. Expand to see full detail (description, BS EN refs, remedial action). "Use This Defect" pre-fills capture form fields. Records usage on selection.

**useDefectLibrary.ts** — Hook for quick-pick fetch, usage recording, and full library search with auth.

Integration: InspectionCapture updated (+117 lines) with "Common Defects" button, manual defect list with severity dots, remove button. Selected defects saved with inspection item and included in `requires_action` logic.

### Domain Configuration
16 asset types: Swing, Slide, Climbing Frame, Roundabout, See-Saw, Spring Rocker, Climbing Net, Monkey Bars, Balance Beam, Multi-Play Unit, Sandpit, Zipline, Pull-Up Bar, Bench, Gate, Fence. Each has inspection points per cadence, risk criteria at 4 severity levels, BS EN defect category references. Standards: BS EN 1176 Parts 1–11, BS EN 1177, BS EN 16630.

### Offline-First Architecture
7 IndexedDB stores: inspections, inspection_items, photos_pending, audio_pending, sync_queue, sites_cache, assets_cache. Background sync via FIFO queue with exponential backoff and dead letter handling. Sites/assets cached with 7-day TTL.

### Security Measures
SSRF (origin-locked), CSRF (auto-inject), DOMPurify (recursive), Sentry PII scrubbing, session timeout (30 min), request throttling (300ms), IndexedDB size guards (photos 10MB/500, audio 50MB/100, text 100KB, queue 1000), signed inspection immutability, ESLint strict.

---

## 8. BACKEND DETAIL (Batch 18 — 34 Cloudflare Worker files + Features 14–15)

### Foundation (13 files)
types.ts, shared/errors.ts, shared/logger.ts, shared/validation.ts, shared/pagination.ts, middleware/cors.ts, middleware/guard.ts, middleware/csrf.ts, middleware/rateLimit.ts, services/db.ts, services/audit.ts, services/idempotency.ts, services/r2.ts

### Routes (13 files)
sites.ts, assets.ts, inspections.ts, inspectionItems.ts, uploads.ts, defects.ts, users.ts, org.ts, dashboard.ts, pdf.ts, helpers.ts, **inspectorPerformance.ts** (F14), **defectLibrary.ts** (F15)

### Webhooks (2 files)
webhooks/clerk.ts, webhooks/stripe.ts

### Services (4 files)
services/speechmatics.ts (60+ term custom dictionary, EU batch, en-GB locale, disfluency removal), services/ai.ts (Claude BS EN prompt, 5-level severity, structured JSON output), services/pdf.ts (BS EN inspection schedule table, recommendations), services/r2.ts

### Queues (2 files)
queues/audioProcessor.ts (Speechmatics → Claude → batch defect INSERT with org_id/site_id/inspection_id/asset_id), queues/pdfGenerator.ts (3 efficient queries, single neon() call)

### Cron (1 file)
**cron/metricsComputation.ts** (F14) — Daily 03:00 UTC. Computes monthly metrics per inspector per org from raw inspection data. 15 metrics. UPSERT strategy (re-running is safe).

### Data (1 file)
**data/defectLibrarySeed.ts** (F15) — 50 seed defects across all 16 asset types with BS EN refs, severity defaults, remedial action templates, cost bands, timeframes, `[PLACEHOLDER]` tokens for inspector customisation.

### Config (3 files)
wrangler.toml (R2 bindings, queue bindings, 2 cron triggers `["0 8 * * *", "0 3 * * *"]`, vars), package.json (wrangler v4), tsconfig.json

### Router (1 file)
index.ts — all feature routes, verify + performance-share endpoints before auth guard (same pattern as webhooks)

### Feature 14 Backend: Inspector Performance
**inspectorPerformance.ts** — 7 endpoints:
- `GET /inspector-performance` — Org overview table (manager/admin)
- `GET /inspector-performance/:userId` — Inspector detail + trends (manager/admin)
- `GET /inspector-performance/:userId/trends` — 6-month trend data
- `GET /my-performance` — Own stats (all members)
- `GET /my-performance/trends` — Own trends
- `GET /inspector-performance/benchmarks` — Anonymised top/middle/bottom 25%
- `POST /inspector-performance/:userId/share` — Generate 30-day share link (manager/admin)
- `GET /performance-share/:token` — Resolve share link (public, no auth, scoped)

Period presets: last_7_days, month, quarter, ytd, rolling_90, custom.

### Feature 15 Backend: Defect Library
**defectLibrary.ts** — 9 endpoints:
- `GET /defect-library` — List (filtered by asset_type/source/search, paginated)
- `GET /defect-library/quick-pick/:assetType` — Top 8 by usage for capture bottom-sheet
- `GET /defect-library/:id` — Single entry
- `GET /defect-library/:id/versions` — Version history
- `POST /defect-library` — Create org entry
- `PUT /defect-library/:id` — Update (creates new version)
- `DELETE /defect-library/:id` — Soft delete
- `POST /defect-library/:id/record-usage` — Increment usage count
- `POST /defect-library/seed` — Idempotent seed (admin only)

RBAC: all members read/pick, manager/admin write, system entries read-only. Protected fields (BS EN refs, severity) require reason + audit log.

---

## 9. FEATURES 1–15 (all built)

### Feature 1: CSV/Excel Defect Export ✅
Server-side Excel (SheetJS), multi-sheet workbook (Defects, Summary by Site, Summary by Risk), risk colour-coding, auto-filters, BS EN refs, photo cross-refs. Client-side offline fallback.

### Feature 2: Make Safe / Close Asset ✅
Formal equipment isolation workflow. Mandatory photo evidence, timestamped audit trail, GPS, offline queuing. Two actions: Make Safe (temporary) and Close Asset (formal removal). Reopening requires separate authorised action with reason.

### Feature 3: Photo Coverage Validation + Cross-Referencing ✅
5 validation rules (3 blocking, 2 warning), sequential numbering (P1, P2…), bidirectional defect↔photo cross-refs. Both PDF generators updated with evidence log sections. Validation blocks sign-off if minimum coverage not met.

### Feature 4: AI Completeness Checks Before Sign-Off ✅
10 deterministic quality checks, A–F grading (100 base, −15 blocking, −5 advisory), canSignOff boolean. No AI API calls — rule-based for speed and reliability. Works offline with local validation fallback.

### Feature 5: Baseline Photo Comparison ✅
Before/after CSS clip-path slider, touch-friendly, condition change detection (Deteriorated/Improved badges). Baseline history audit table. Three UI states: no baseline / baseline only / full comparison.

### Feature 6: Council Procurement Pack ✅ (9 documents)
DPIA (8 sections, 10-risk matrix), DPA (12 clauses, UK GDPR), Security Controls (Cyber Essentials mapping), Technical Spec + SLA (99.5%/99.9%, P1–P4 response), Commercial Terms (£149/£349, 60-day pilot), Training & Migration Guide (10-day timeline), Asset Import Template, Site Import Template, Sample Defect Export (5 sheets, 12 realistic defects).

### Feature 7: Hotlist on Manager Dashboard ✅
Top 20 open VH/H defects with SLA timers, severity badges, made-safe indicators, overdue highlighting (red bg), one-click drill-in. Dashboard completely rewritten with 5 parallel queries. Empty state: green checkmark.

### Feature 8: Longitudinal Risk + Asset History ✅
Condition timeline SVG chart (Good=4→Dangerous=1), repeat defect detection (same BS EN ref 2+), server-computed trend (improving/stable/deteriorating). 4 parallel queries. AssetDetail completely rewritten.

### Feature 9: Incident/Complaint Linking + One-Click Claims Pack ✅
40+ column incidents table (RIDDOR, HSE, police, insurer). 8-section collapsible form. Claims pack: 9 parallel queries, 12-month evidence window, compliance percentage, plain-English verdict. Legal defence tool.

### Feature 10: Tamper-Evident Export Bundles ✅
SHA-256 manifest + HMAC-SHA256 signature + hash chain in zip bundle (fflate). Public verification endpoint (no auth, rate-limited 30/min, zero PII). Signing key versioning (`signing_key_id`) from day one. R2 storage: `sealed-exports/{org_id}/{bundle_id}.zip`.

### Feature 11: Weekly/Monthly Manager Summary Emails ✅
Cloudflare Cron Triggers (Monday 8am weekly, 1st of month monthly). Resend API + React Email TSX templates. Weekly: hotlist, overdue, compliance %. Monthly: trends, inspector activity, condition changes. Token-based unsubscribe. "Nothing to report" threshold. Max 50 emails per cron.

### Feature 12: AI Style Normalisation ✅
Per-field inline normalise button + batch "Normalise All Fields" before sign-off. Claude API with org-specific style config: 3 presets (Formal/Technical/Plain English) + custom guide + before/after examples. Monthly token budget per org. Accept/reject per suggestion. Normalisation history page with usage stats.

### Feature 13: Today's Route Planning ✅
Mapbox GL JS v3 with urgency-coded SVG pins (overdue=red, due_today=orange, this_week=yellow, this_month=blue, not_due=green). RBAC-filtered sites via site_assignments table (admin/manager see all, inspector sees assigned only). Server-side Mapbox Optimization API (≤12 stops) + Directions API (≤25 coords for drag-to-reorder). Geolocation, route summary overlay, responsive layout (side-by-side desktop / toggle mobile).

### Feature 14: Inspector Performance & Quality Insights ✅
Precomputed daily/monthly/quarterly aggregates with 15 metrics per inspector per org. Manager overview table (sortable by any metric, filterable by period + inspection type). Inspector detail page with KPI cards, 6-month trend sparklines, and anonymised benchmark bands (top 25%/middle/bottom 25%). Self-view via `/my-performance`. Embeddable `MyPerformanceCard` on dashboard. Token-based "Your Month" share links (public, no auth, 30-day expiry). Daily cron at 03:00 UTC computes metrics. RBAC: managers see org-wide, inspectors see own only.

### Feature 15: Defect Library ✅
Versioned library of common defects with system (50 seed entries across 16 asset types) and org-created entries. Each entry: title, description template, BS EN refs, severity default, remedial action template, cost band, timeframe. Immutable version snapshots — updates create new versions. Protected field edits (BS EN refs, severity) require reason + audit log. Quick-pick bottom-sheet during capture filtered by asset type, sorted by usage count. Usage tracking for popularity ranking. Manager UI for library management with version history drawer. RBAC: all members read/pick, manager/admin write, system entries read-only. AI integration deferred — future: AI generates freeform → matches library with confidence score → auto-apply above threshold.

---

## 10. DEPENDENCIES

### Frontend (`package.json`)
```json
{
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.22.0",
    "react-helmet-async": "^2.0.3",
    "lucide-react": "^0.344.0",
    "dompurify": "^3.0.8",
    "@sentry/react": "^7.100.0",
    "@clerk/clerk-react": "^5.x",
    "idb": "^8.0.0",
    "uuid": "^9.0.0",
    "pdf-lib": "^1.17.1",
    "mapbox-gl": "^3.3.0",
    "react-map-gl": "^7.1.7"
  },
  "devDependencies": {
    "typescript": "^5.3.3",
    "vite": "^5.1.0",
    "@vitejs/plugin-react": "^4.2.1",
    "tailwindcss": "^3.4.1",
    "postcss": "^8.4.35",
    "autoprefixer": "^10.4.17",
    "@types/react": "^18.2.55",
    "@types/react-dom": "^18.2.19",
    "@types/dompurify": "^3.0.5",
    "@types/uuid": "^9.0.7",
    "@types/node": "^20.11.16",
    "@typescript-eslint/eslint-plugin": "^7.0.0",
    "@typescript-eslint/parser": "^7.0.0",
    "eslint": "^8.56.0",
    "vite-plugin-pwa": "^0.17.5"
  }
}
```

### Worker (`workers/package.json`)
Key dependencies: `wrangler` (v4), `@neondatabase/serverless`, `fflate` (zip), `xlsx` (SheetJS), `resend`, `@react-email/components`, `pdf-lib`

---

## 11. INFRASTRUCTURE

### Cloudflare
| Setting | Value |
|---------|-------|
| Account ID | `d5f2a04b6d59db804400d72e297f7561` |
| Worker subdomain | `micks43.workers.dev` |
| Worker URL | `https://inspectvoice-api.micks43.workers.dev` |
| R2 Bucket | `inspectvoice-storage` |
| Queues | `inspectvoice-audio-processing`, `inspectvoice-pdf-generation`, + 2 DLQs |
| Cron Triggers | `0 8 * * *` (summary emails), `0 3 * * *` (metrics computation) |

### Neon
| Setting | Value |
|---------|-------|
| Project | inspectvoice |
| Region | AWS eu-west-2 (London) |
| Schema | All 21 tables deployed ✅ |
| Connection | `DATABASE_URL` secret in Cloudflare Worker |

### Railway
Frontend auto-deploys on push to `main`. Build-time env vars: `VITE_CLERK_PUBLISHABLE_KEY`, `VITE_MAPBOX_TOKEN`, `VITE_API_BASE_URL`.

### CI/CD
- Frontend: Railway auto-deploy on push to `main`
- Worker: Cloudflare GitHub integration auto-deploy on push to `main` (root: `workers/`)
- Database: Manual migration via Neon SQL Editor
- Worker build: `echo 'Typecheck skipped — wrangler handles bundling'` (100+ pre-existing TS errors, esbuild ignores them)

### All Worker Secrets
| Secret | Status |
|--------|--------|
| DATABASE_URL | ✅ |
| CLERK_SECRET_KEY | ✅ |
| CLERK_JWKS_URL | ✅ (`https://set-bullfrog-58.clerk.accounts.dev/.well-known/jwks.json`) |
| CLERK_ISSUER | ✅ (`https://set-bullfrog-58.clerk.accounts.dev`) |
| CLERK_AUTHORIZED_PARTIES | ✅ (`https://inspectvoice-production.up.railway.app`) |
| ANTHROPIC_API_KEY | ✅ |
| SPEECHMATICS_API_KEY | ✅ |
| UPSTASH_REDIS_URL | ✅ |
| UPSTASH_REDIS_TOKEN | ✅ |
| MAPBOX_ACCESS_TOKEN | ✅ |
| MANIFEST_SIGNING_KEY | ⏳ Needed for Feature 10 runtime |
| MANIFEST_SIGNING_KEY_ID | ⏳ Needed for Feature 10 runtime |
| RESEND_API_KEY | ⏳ Needed for Feature 11 runtime |

---

## 12. ROUTING (current)

```
/sign-in                    → Clerk sign-in (public)
/sign-up                    → Clerk sign-up (public)
/                           → Manager Dashboard (F7: Hotlist + F14: Performance)
/sites                      → Site list
/sites/new                  → Create site
/sites/:id                  → Site detail + asset register
/sites/:id/edit             → Edit site
/sites/:siteId/assets/new   → Create asset
/sites/:siteId/assets/:id   → Asset detail (F8: condition timeline)
/sites/:siteId/assets/:id/edit → Edit asset
/sites/:siteId/inspections/new → Start inspection
/sites/:siteId/inspections/:id/capture → Capture workflow (F5: baseline + F15: quick-pick)
/sites/:siteId/inspections/:id/review  → Review + sign-off (F4+F12)
/inspections                → Inspection list
/defects                    → Defect tracker
/incidents                  → Incident list (F9)
/incidents/new              → Create incident (F9)
/incidents/:id/edit         → Edit incident (F9)
/inspector-performance      → Inspector performance overview (F14, manager/admin)
/inspector-performance/:userId → Inspector detail drill-in (F14, manager/admin)
/my-performance             → Inspector own stats (F14, all members)
/defect-library             → Defect library management (F15, manager/admin)
/route-planner              → Route planning (F13)
/normalisation-history      → Normalisation log (F12)
/sealed-exports             → Sealed exports list (F10)
/settings                   → Settings (F12: normalisation config)
/verify/:bundleId           → Public verification (F10, no auth)
/performance-share/:token   → Public performance share (F14, no auth)
```

---

## 13. DEPLOYMENT STATUS (26 Feb 2026)

### What's Deployed & Working
- ✅ All 21 database tables in Neon
- ✅ Cloudflare Worker with all 15 feature routes
- ✅ Railway frontend with Clerk auth, all pages, green build
- ✅ CI/CD: GitHub auto-deploy for both Worker and frontend
- ✅ Clerk sign-in, JWT v2, guard passing, dashboard loading
- ✅ Mapbox tokens configured (frontend + Worker)
- ✅ 2 cron triggers configured (08:00 emails + 03:00 metrics)

### Pending Deployment
- ⏳ Features 1–5 code files — built, pending commit to repo
- ⏳ Feature 11 + 12 Worker files — built, pending commit
- ⏳ 3 Worker secrets: MANIFEST_SIGNING_KEY, MANIFEST_SIGNING_KEY_ID, RESEND_API_KEY

### Feature Status

| # | Feature | Status |
|---|---------|--------|
| 1 | CSV/Excel Defect Export | ✅ Built |
| 2 | Make Safe / Close Asset | ✅ Built |
| 3 | Photo Coverage Validation | ✅ Built |
| 4 | AI Completeness Checks | ✅ Built |
| 5 | Baseline Photo Comparison | ✅ Built |
| 6 | Council Procurement Pack | ✅ Built |
| 7 | Hotlist Dashboard | ✅ Deployed |
| 8 | Asset History | ✅ Deployed |
| 9 | Incidents + Claims Pack | ✅ Deployed |
| 10 | Tamper-Evident Bundles | ✅ Deployed |
| 11 | Manager Summary Emails | ✅ Built, pending secrets |
| 12 | AI Style Normalisation | ✅ Built, pending secrets |
| 13 | Route Planning | ✅ Deployed |
| 14 | Inspector Performance | ✅ Built (20 files, pending commit) |
| 15 | Defect Library | ✅ Built (20 files, pending commit) |

---

## 14. WHAT'S NEXT

1. **Rename migration** — `007_inspector_performance_and_defect_library.sql` → `009_inspector_performance_and_defect_library.sql` before running in Neon
2. **Commit Features 14–15** — 20 files across frontend + backend (built 26 Feb 2026)
3. **Configure remaining secrets** — MANIFEST_SIGNING_KEY + KEY_ID, RESEND_API_KEY
4. **Commit Features 1–5** — wire into codebase
5. **Commit Feature 11 + 12 Worker files** — push for auto-deploy
6. **Steps 10.11–10.12** — sealed export options on InspectionReview + IncidentForm
7. **Site assignment admin UI** — manager page to assign inspectors to sites (data model ready)
8. **Fix pre-existing TS errors** — 100+ across Worker codebase, then restore `tsc --noEmit` to build
9. **Seed test data** — test site + inspection for end-to-end verification
10. **Customise procurement pack** — placeholder fields, pricing, solicitor review of DPA
11. **Sample PDF report** — redacted sample for procurement pack
12. **Stripe integration** — payment webhooks, plan management
13. **Domain** — `inspectvoice.co.uk` (zone exists in Cloudflare, no Worker route yet)
14. **Cyber Essentials certification** — Q3 2026, controls mapped
15. **Pilot outreach** — 60-day free pilot offer to councils

---

## 15. KEY LEARNINGS

1. **Vite env vars are build-time** — changing `VITE_*` requires redeploy
2. **Clerk v2 JWT** — org claims in nested `o` object, not flat `org_id`/`org_role`
3. **OrgGate required** — without active org, JWT lacks org_id, guard rejects
4. **Auth token bridge** — module-level getter/setter bridges React hooks to plain functions
5. **Cloudflare root directory** — must point to `workers/` subfolder
6. **wrangler.toml `[vars]` override dashboard** — deploying overwrites dashboard-set env vars
7. **esbuild vs tsc** — esbuild only catches import/export mismatches, not type errors
8. **500 vs 401 vs 403** — 500 after auth changes proves guard working, error is downstream
9. **Sealed exports immutable** — no updated_at column or trigger
10. **Signing key versioning from day one** — prevents rotation nightmares
11. **TypeScript strict array indexing** — `array[index]` returns `T | undefined`
12. **react-map-gl Map clashes with built-in Map** — rename to MapGL
13. **Phantom `@types` packages** — `"types": []` in tsconfig prevents auto-discovery
14. **Mapbox Optimization API ≤12 stops** — design UX around this from day one
15. **Speechmatics replaced Deepgram** — EU batch API, enhanced model, 60+ term custom dictionary
16. **Migration schema alignment** — table names (`organisations` not `orgs`), TEXT not UUID for Clerk IDs
17. **Never reconstruct existing files from memory** — always ask for the current file before editing; rebuilding drops lines silently

---

---

## 17. FEATURE 16: CLIENT PORTAL (built 26 Feb 2026)

### What It Is
A separate client-facing portal where councils and site owners can view inspection data, track defects, submit remedial updates, and receive notifications — without accessing the inspector platform. Separate Clerk auth boundary, separate RBAC, read-only by default with contributor write access for defect updates.

### Database (Migration 010 — 7 tables, deployed to Neon)
| Table | Purpose |
|-------|---------|
| `client_workspaces` | Client tenant (council/site owner). Clerk org, slug, branding JSONB, status |
| `client_workspace_providers` | Link table: client workspace to inspection company (many-to-many ready, V1 ships 1:1) |
| `client_users` | Client user accounts (portal Clerk). Role: viewer/contributor/admin |
| `client_site_access` | Granular site-level permissions per workspace. Access level: full/restricted |
| `client_defect_updates` | Client assertions on defects (acknowledge/comment/work_complete/contractor_booked/unable_to_action). NOT authoritative — inspector must verify |
| `client_magic_links` | Token-hash-based one-off resource access (PDF/Excel/sealed bundle). SHA-256, expiry, use count limits |
| `client_notifications` | Notification records per client user (report published, critical defect, status change, remedial verified) |

25 indexes, 8 RLS policies, 2 triggers, 17 check constraints.

### Backend (Cloudflare Workers — 5 new files)

**portalGuard.ts** (`workers/src/middleware/`) — Separate auth boundary using PORTAL_CLERK_* env vars. JWT verification against portal Clerk JWKS. Resolves client_workspace + client_user from DB. Role hierarchy: viewer < contributor < admin. Magic link verification (SHA-256 hash lookup, expiry/use-count enforcement, access metadata logging).

**clientWorkspaces.ts** (`workers/src/routes/`) — 13 inspector-side management endpoints behind regular guard. Workspace CRUD, client user invite/manage, site access grant/revoke, verification queue (prioritised by update type). RBAC: manager+ for management, inspector+ for verification.

**portal.ts** (`workers/src/routes/`) — 10 portal-side client endpoints behind portalGuard. Dashboard, sites, inspections, defects (with filters), defect detail with update history, submit defect update (contributor+), notifications with mark-read.

**magicLinks.ts** (`workers/src/routes/`) — Inspector-side magic link CRUD (create/list/revoke) + public resource resolution (PDF download from R2, sealed bundle download). Token generated with crypto.getRandomValues, only SHA-256 hash stored.

**clientNotifications.ts** (`workers/src/services/`) — 4 notification trigger functions: notifyReportPublished, notifyCriticalDefect, notifyDefectStatusChanged, notifyRemedialVerified. Fire-and-forget, scoped through client_site_access.

**index.ts** updated with portal route table, portalGuard wiring, magic link handler, and all new imports.

**types.ts** updated with PortalRequestContext, MagicLinkContext, all Feature 16 entity types and enums.

### Frontend (14 new files)

**Portal infrastructure (4 files):**
- `src/portal/api/portalApi.ts` — Typed fetch wrapper for all /api/v1/portal/* endpoints
- `src/portal/auth/PortalAuthProvider.tsx` — Clerk wrapper using VITE_PORTAL_CLERK_PUBLISHABLE_KEY
- `src/portal/layout/PortalLayout.tsx` — Sidebar nav + header with notification badge, mobile-responsive
- `src/portal/PortalRouter.tsx` — Routes /portal/* to pages, wraps in auth + layout

**Portal pages (8 files in `src/portal/pages/`):**
- `DashboardPage.tsx` — Stat cards (sites, open defects, critical, pending), recent reports list. Also exports shared components: RiskBadge, SeverityBadge, StatusBadge, LoadingSkeleton, ErrorCard, fmtDate, fmtType
- `SitesPage.tsx` — Card grid of granted sites with asset counts + open defects
- `SiteDetailPage.tsx` — Site info, assets table, recent inspections list
- `InspectionsPage.tsx` — Paginated table of signed reports with risk badges
- `InspectionDetailPage.tsx` — Full report: severity breakdown, inspection items, defects found
- `DefectsPage.tsx` — Filterable defect list (severity/status dropdowns), client update status
- `DefectDetailPage.tsx` — Full defect info + submit update form (5 update types) + update history with verification status
- `NotificationsPage.tsx` — Notification list with mark-read and mark-all-read

**App.tsx** updated with portal route: `<Route path="/portal/*" element={<PortalRouter />} />`

### Portal Clerk Application
- App name: InspectVoice Portal
- Frontend API: `https://eminent-falcon-42.clerk.accounts.dev`
- Publishable key: `pk_test_ZW1pbmVudC1mYWxjb24tNDIuY2xlcmsuYWNjb3VudHMuZGV2JA`

### Secrets Configured
| Secret | Location | Status |
|--------|----------|--------|
| PORTAL_CLERK_JWKS_URL | Cloudflare Worker | Deployed |
| PORTAL_CLERK_SECRET_KEY | Cloudflare Worker (encrypted) | Deployed |
| PORTAL_CLERK_ISSUER | Cloudflare Worker | Deployed |
| PORTAL_CLERK_AUTHORIZED_PARTIES | Cloudflare Worker | Deployed |
| VITE_PORTAL_CLERK_PUBLISHABLE_KEY | Railway | Deployed |

### Key Design Decisions
1. **Separate Clerk instance** — portal users never see inspector data or UI. Complete auth boundary separation.
2. **Client assertions, not authoritative changes** — clients propose status (work_complete etc), inspector must verify. Separation of duties for defensible audit trail.
3. **Magic links store hash only** — SHA-256, plaintext token returned once at creation, never stored or retrievable.
4. **Notification triggers are fire-and-forget** — failures don't block inspector workflows.
5. **Site access is explicit** — clients only see sites granted to their workspace via client_site_access.
6. **Portal uses light theme** — deliberate contrast with dark-themed inspector platform to make it obvious which side you're on.

### Routes Added
```
/portal                     → Client dashboard
/portal/sites               → Sites list
/portal/sites/:id           → Site detail + assets
/portal/inspections         → Inspection reports list
/portal/inspections/:id     → Inspection report detail
/portal/defects             → Defect tracker (filterable)
/portal/defects/:id         → Defect detail + submit update
/portal/notifications       → Notification list
```

### V2 Deferred
- Request reinspection workflow
- Client-side file upload for remedial evidence (attachments field exists, upload endpoint not built)
- Email delivery for notifications (DB records created, Resend integration deferred)
- Client workspace branding customisation UI
- Organisation-level portal settings (auto-grant sites, default roles)

### Updated Feature Status Table Entry
| # | Feature | Status |
|---|---------|--------|
| 16 | Client Portal | Deployed (backend + frontend + auth + secrets) |

### Updated Repository Structure Additions
```
migrations/
  010_client_portal.sql

src/portal/
  PortalRouter.tsx
  api/portalApi.ts
  auth/PortalAuthProvider.tsx
  layout/PortalLayout.tsx
  pages/
    DashboardPage.tsx
    SitesPage.tsx
    SiteDetailPage.tsx
    InspectionsPage.tsx
    InspectionDetailPage.tsx
    DefectsPage.tsx
    DefectDetailPage.tsx
    NotificationsPage.tsx

workers/src/
  middleware/portalGuard.ts
  routes/clientWorkspaces.ts
  routes/portal.ts
  routes/magicLinks.ts
  services/clientNotifications.ts
```

### Database Total: 28 tables (was 21 + 7 new)

---

## 16. HOW TO CONTINUE IN A NEW CHAT

Upload this document. Then say: *"Continue InspectVoice build. Here's my master reference. [Task description]."*

If modifying existing files, upload the current version from GitHub before editing — never work from stale copies. Claude will ask for what it needs.

Mick commits via GitHub web interface, max 3 files at a time. Every file must be complete, copy-paste ready, production-ready first time.
