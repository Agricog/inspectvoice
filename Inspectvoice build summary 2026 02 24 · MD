# InspectVoice — Master Build Reference

**Last updated:** 26 February 2026
**Status:** 13 features built, backend deployed, auth working, CI/CD operational
**GitHub repo:** `https://github.com/Agricog/inspectvoice`

---

## 1. WHAT INSPECTVOICE IS

InspectVoice is a voice-driven, AI-assisted inspection platform for UK parks, playgrounds, and outdoor recreation assets. It eliminates 1–2 hours of post-inspection admin per site by converting voice dictation into BS EN 1176/1177-compliant inspection reports.

**How it works:** An inspector walks a site, taps each asset on their phone, speaks observations. The system transcribes via Speechmatics, analyses against BS EN standards via Claude, and returns structured defect data with risk ratings, BS EN section references, remedial actions, cost bands, and action timeframes. The inspector reviews, confirms or overrides, signs off, and a professional PDF is generated.

**Three inspection types (per BS EN 1176-7:2020):**
- **Routine Visual** — daily/weekly walk-around, quick hazard check (~15 min)
- **Operational** — 1–3 monthly functional testing, wear assessment (~1 hour)
- **Annual Main** — comprehensive engineering inspection, full compliance audit (~3 hours)

**Business model:** Multi-tenant SaaS with Stripe billing. Team £149/mo, Enterprise £349/mo. Target: independent RoSPA/RPII inspectors, council parks departments, playground maintenance companies. Competitors: iCertifi (market leader, iOS only), Tradecert (AI observation wording), Pro Certs, EasyCert — **none offer voice-first capture.**

---

## 2. TECH STACK

| Layer | Technology |
|---|---|
| Frontend | React 18.3.1 + TypeScript strict + Vite + Tailwind CSS |
| Backend | Cloudflare Workers (`inspectvoice-api`) |
| Database | Neon PostgreSQL (AWS eu-west-2 London) |
| Storage | Cloudflare R2 (`inspectvoice-storage`) |
| Auth | Clerk (JWT + webhooks, RBAC, multi-tenancy) |
| STT | Speechmatics Batch API (EU, enhanced model) + Web Speech API (fallback) |
| AI | Anthropic Claude Sonnet 4 |
| Queues | Cloudflare Queues (audio processing, PDF generation) |
| PDF | pdf-lib (not jspdf) |
| Maps | Mapbox GL JS v3 + react-map-gl (route planning) |
| Email | Resend + React Email (scheduled digests) |
| Rate Limiting | Upstash Redis (tenant-scoped) |
| Frontend Hosting | Railway (auto-deploy on push to `main`) |
| Payments | Stripe (subscription webhooks) |
| Error Tracking | Sentry (with PII scrubbing) |

---

## 3. BUILD STANDARD (Autaimate v3 — non-negotiable)

- TypeScript strict mode with `noUncheckedIndexedAccess` — zero `any`
- Every file ships production-ready first time — no rework passes
- Server-side validation on all endpoints (Zod schemas)
- Multi-tenancy: `org_id` on every table, RLS policies, server-side enforcement
- RBAC via Clerk org roles, enforced at API level
- Offline-first: IndexedDB queue-and-sync, graceful degradation
- Audit logging: requestId, userId, orgId, timestamp on all state changes
- DOMPurify sanitisation on all user input
- SSRF protection: fetch locked to `VITE_API_BASE_URL` origin
- CSRF tokens on all state-changing requests
- Sentry PII scrubbing (auth headers, cookies, URL tokens)
- Signed inspections are immutable — no backward state transitions
- pdf-lib only — never jspdf
- Dark theme only — design tokens (`iv-text`, `iv-muted`, `iv-surface`)
- Path aliases: `@/`, `@components/`, `@pages/`, `@hooks/`, `@services/`, `@utils/`, `@types/`, `@config/`
- Mick works via GitHub web interface only — no terminal/CLI

### Design System
- Dark theme: bg `#0C0F14`, surface `#151920`, accent `#22C55E`
- Risk colours: very-high `#EF4444`, high `#F97316`, medium `#EAB308`, low `#22C55E`
- Fonts: Inter (UI), JetBrains Mono (code/data)
- Mobile-first responsive
- Component classes: `iv-btn-primary`, `iv-btn-secondary`, `iv-btn-icon`, `iv-panel`, `iv-badge`, `iv-input`, `iv-select`, `iv-label`, `iv-card`, `iv-card-interactive`

---

## 4. ARCHITECTURE

```
Browser → Railway (React 18 + TypeScript + Vite + Tailwind CSS frontend)
  ↓ Clerk sign-in (ClerkProvider → AuthTokenProvider → AuthGate → OrgGate)
  ↓ JWT in Authorization header (v2 format, org claims in o.id)
  ↓
Cloudflare Worker (inspectvoice-api)
  ↓ guard.ts: verify JWT via JWKS, validate issuer + azp, extract org_id
  ↓ RequestContext: { userId, orgId, userRole, requestId }
  ↓
Route handlers → Neon PostgreSQL (via @neondatabase/serverless)
  ↓
R2 bucket (photos, audio, sealed-exports/{org_id}/{bundle_id}.zip)
Queues (inspectvoice-audio-processing, inspectvoice-pdf-generation + DLQs)
Cron Triggers (weekly/monthly summary emails)
  ↓
Speechmatics (transcription) → Claude API (AI analysis + normalisation)
Resend API (email delivery)
Mapbox API (route optimisation + directions — server-side only)
```

### Key Architectural Decisions

**Inspection State Machine:** `DRAFT → REVIEW → SIGNED → EXPORTED` — once SIGNED, immutable (enforced at DB trigger level). No backward transitions.

**AI Pipeline:** Voice → Speechmatics (transcription) → Claude Sonnet (BS EN analysis) → Structured JSON. Async via Cloudflare Queues. Inspector reviews and confirms (maintains liability).

**Multi-tenancy:** Server-side only. Every API endpoint validates Clerk JWT, derives tenantId from org claims. RLS in Neon PostgreSQL. Frontend never trusted with tenant filtering.

**Offline-First:** All inspection data captured to IndexedDB first. Background sync when online. Inspections never block on connectivity. Last write wins for drafts, immutable once signed.

**Clerk v2 JWT Format:**
```json
{
  "sub": "user_xxx",
  "o": { "id": "org_xxx", "rol": "admin", "slg": "inspectvoice-xxx" },
  "v": 2
}
```
Guard supports both v1 (flat `org_id`/`org_role`) and v2 (nested `o` object).

---

## 5. REPOSITORY STRUCTURE

```
inspectvoice/
├── .github/workflows/deploy-worker.yml
├── migrations/
│   ├── 001_initial_schema.sql          # 10 core tables, 22 indexes, 5 RLS, 8 triggers
│   ├── 002_make_safe.sql               # Feature 2: asset_safety_actions
│   ├── 003_baseline_photos.sql         # Feature 5: baseline columns + history
│   ├── 004_incidents.sql               # Feature 9: incidents (40+ columns)
│   ├── 005_sealed_exports.sql          # Feature 10: immutable sealed exports
│   ├── 006_email_preferences.sql       # Feature 11: email_preferences + send_log
│   ├── 007_normalisation.sql           # Feature 12: normalisation_log + usage
│   └── 008_site_assignments.sql        # Feature 13: site_assignments (RBAC)
│
├── src/                                # Frontend (React/Vite)
│   ├── main.tsx                        # Entry — ClerkProvider + AuthTokenProvider + Sentry
│   ├── App.tsx                         # Routes — AuthGate, OrgGate, all page routes
│   ├── index.css                       # Tailwind + component library + design tokens
│   ├── mapbox-gl.d.ts                  # Type stub for phantom @mapbox/point-geometry
│   ├── vite-env.d.ts
│   ├── components/
│   │   ├── Layout.tsx                  # App shell — header, nav, offline banner, footer
│   │   ├── AuthTokenProvider.tsx       # Clerk token bridge (renders nothing)
│   │   ├── BaselineComparison.tsx      # F5: Before/after slider
│   │   ├── CompletenessCheckModal.tsx  # F4: Review gate modal
│   │   ├── DefectExportButton.tsx      # F1+F10: Export UI with sealed option
│   │   ├── DefectTracker.tsx           # F2: Make Safe integration
│   │   ├── EmailPreferences.tsx        # F11: Email settings panel
│   │   ├── MakeSafeModal.tsx           # F2: Safety action modal
│   │   ├── NormaliseButton.tsx         # F12: Per-field inline normalise
│   │   ├── NormalisationReviewPanel.tsx # F12: Batch diff review modal
│   │   ├── NormalisationSettings.tsx   # F12: Admin style config
│   │   └── VerificationBadge.tsx       # F10: Seal status display
│   ├── config/
│   │   ├── index.ts
│   │   ├── complianceStandards.ts      # BS EN 1176/1177/16630 reference
│   │   └── assetTypes.ts              # 16 asset type configs
│   ├── hooks/
│   │   ├── useFetch.ts                # SSRF + CSRF + throttle + retry + Bearer auto-inject
│   │   ├── useFormValidation.ts
│   │   ├── useSessionTimeout.ts
│   │   └── useOnlineStatus.ts
│   ├── pages/
│   │   ├── AssetDetail.tsx            # F8: Rewrite with condition timeline + history
│   │   ├── AssetForm.tsx              # Create/edit equipment
│   │   ├── DefectTracker.tsx          # Defect tracker dashboard
│   │   ├── IncidentForm.tsx           # F9: 8-section incident form
│   │   ├── IncidentList.tsx           # F9: Filterable incident register
│   │   ├── InspectionCapture.tsx      # F5: Core capture + baseline integration
│   │   ├── InspectionList.tsx         # All inspections, filter by status/type/date
│   │   ├── InspectionReview.tsx       # F4+F12: Sign-off + normalisation
│   │   ├── InspectionStart.tsx        # Select type, weather, asset register
│   │   ├── ManagerDashboard.tsx       # F7: Rewrite with Hotlist
│   │   ├── NormalisationHistoryPage.tsx # F12: Usage stats + log
│   │   ├── RoutePlanner.tsx           # F13: Mapbox GL map + route optimisation
│   │   ├── SettingsPage.tsx           # F12: NormalisationSettings wired in
│   │   ├── SiteDetail.tsx             # Site info + asset register + inspections
│   │   ├── SiteForm.tsx               # Create/edit site
│   │   └── SiteList.tsx               # Search, filter, sort sites
│   ├── services/
│   │   ├── defectExport.ts            # F1: Client-side Excel export (offline)
│   │   ├── offlineStore.ts            # IndexedDB 7 stores, sync queue, size guards
│   │   ├── pdfGenerator.ts            # F3: Client PDF with evidence log
│   │   ├── photoCoverage.ts           # F3: Photo validation + cross-refs
│   │   ├── photoCapture.ts            # Camera, compression, thumbnails, EXIF GPS
│   │   ├── sealedExport.ts            # F10: Client-side sealed export helpers
│   │   ├── syncService.ts             # Background sync engine (FIFO, backoff, R2)
│   │   └── voiceCapture.ts            # Web Speech API + MediaRecorder
│   ├── types/
│   │   ├── index.ts                   # Barrel export
│   │   ├── entities.ts                # All entity interfaces (1:1 with Neon schema)
│   │   ├── enums.ts                   # 25+ enums with label/description maps
│   │   ├── normalisation.ts           # F12: Full normalisation type definitions
│   │   └── offline.ts                 # IndexedDB wrapper types, sync queue types
│   └── utils/
│       ├── analytics.ts               # Privacy-respecting event tracking
│       ├── authToken.ts               # Clerk token bridge (module-level getter/setter)
│       ├── csrf.ts                    # CSRF token management
│       ├── errorTracking.ts           # Sentry init with PII scrubbing
│       ├── sanitization.ts            # DOMPurify wrappers
│       └── validation.ts              # Validation framework + domain validators
│
├── workers/                           # Backend (Cloudflare Workers)
│   ├── package.json                   # wrangler v4, fflate, xlsx, resend, @react-email
│   ├── tsconfig.json
│   ├── wrangler.toml                  # R2 bindings, queues, cron triggers, vars
│   └── src/
│       ├── index.ts                   # Main router — all feature routes + verify before auth
│       ├── types.ts                   # Env interface (all secrets), ClerkJwtPayload (v1+v2)
│       ├── middleware/
│       │   ├── cors.ts
│       │   ├── csrf.ts
│       │   ├── guard.ts               # Clerk JWT verification, v1+v2, issuer/azp validation
│       │   └── rateLimit.ts           # Upstash Redis
│       ├── queues/
│       │   ├── audioProcessor.ts      # Speechmatics → Claude → batch defect INSERT
│       │   └── pdfGenerator.ts        # Server-side PDF generation queue consumer
│       ├── routes/
│       │   ├── webhooks/
│       │   │   ├── clerk.ts
│       │   │   └── stripe.ts
│       │   ├── assets.ts
│       │   ├── assetHistory.ts        # F8: 4 parallel queries
│       │   ├── claimsPack.ts          # F9: 9 parallel queries
│       │   ├── completenessCheck.ts   # F4: 10 deterministic checks
│       │   ├── dashboard.ts           # F7: 5 parallel queries + hotlist
│       │   ├── defectExport.ts        # F1: Server-side Excel
│       │   ├── defects.ts
│       │   ├── emailCron.ts           # F11: Cron trigger handler
│       │   ├── emailPreferences.ts    # F11: GET/PATCH preferences
│       │   ├── emailUnsubscribe.ts    # F11: Token-based unsubscribe (no auth)
│       │   ├── helpers.ts
│       │   ├── incidents.ts           # F9: CRUD
│       │   ├── inspectionItems.ts
│       │   ├── inspections.ts
│       │   ├── normalise.ts           # F12: field/batch/usage/accept-reject
│       │   ├── org.ts
│       │   ├── pdf.ts                 # BS EN inspection schedule table
│       │   ├── routePlanner.ts        # F13: sites/optimise/directions
│       │   ├── safetyActions.ts       # F2: Make Safe/Close endpoints
│       │   ├── sealedExport.ts        # F10: 5 sealed export endpoints
│       │   ├── sites.ts
│       │   ├── uploads.ts
│       │   ├── users.ts
│       │   └── verify.ts             # F10: Public verification (no auth)
│       ├── services/
│       │   ├── ai.ts                  # Claude prompt with BS EN context
│       │   ├── audit.ts
│       │   ├── db.ts
│       │   ├── emailSender.ts         # F11: Resend API wrapper
│       │   ├── emailTemplates.tsx      # F11: React Email TSX templates
│       │   ├── excelGenerator.ts      # F10: Server-side Excel (SheetJS)
│       │   ├── idempotency.ts
│       │   ├── normalise.ts           # F12: Claude API normalisation service
│       │   ├── pdf.ts                 # F3: Worker PDF with evidence log
│       │   ├── r2.ts
│       │   ├── sealedExport.ts        # F10: Core sealing service
│       │   └── speechmatics.ts        # EU batch API, 60+ term custom dictionary
│       └── shared/
│           ├── errors.ts
│           ├── logger.ts
│           ├── pagination.ts
│           └── validation.ts          # validateRequiredString + Zod helpers
│
├── procurement-pack/                  # Feature 6: 9 council tender documents
│   ├── InspectVoice-DPIA-v1.0.docx
│   ├── InspectVoice-DPA-v1.0.docx
│   ├── InspectVoice-Security-Controls-v1.0.docx
│   ├── InspectVoice-Technical-Spec-SLA-v1.0.docx
│   ├── InspectVoice-Commercial-Terms-v1.0.docx
│   ├── InspectVoice-Training-Migration-Guide-v1.0.docx
│   ├── InspectVoice-Asset-Import-Template.xlsx
│   ├── InspectVoice-Site-Import-Template.xlsx
│   └── InspectVoice-SAMPLE-Defect-Export.xlsx
│
├── index.html
├── package.json                       # Frontend deps
├── tsconfig.json                      # "types": [] for phantom @types prevention
├── tsconfig.node.json
├── vite.config.ts
├── tailwind.config.ts
├── postcss.config.js
└── .eslintrc.cjs
```

---

## 6. DATABASE SCHEMA (Neon — all 17 tables deployed ✅)

### Migration 001: Core Schema (10 tables)

**organisations** — Clerk org sync, Stripe billing, branding, settings JSONB, accreditation
- PK: `id` (UUID), unique `org_id` (TEXT — Clerk org_xxx)
- Stripe: customer_id, subscription_id, status (trialing/active/past_due/cancelled/unpaid/incomplete/expired), plan, period_end, trial_ends_at
- Settings JSONB: default_inspection_type, require_manager_approval, auto_export_on_sign
- Branding: logo_url, primary_color (#22C55E default)

**users** — Clerk user sync, inspector credentials
- PK: `id` (TEXT — Clerk user_xxx), FK to organisations(org_id)
- Inspector: rospa_certification_number, rpii_number, rpii_grade, other_qualifications
- Insurance: provider, policy_number
- Role: inspector/manager/admin
- Status: is_active, deactivated_at, last_login_at

**sites** — Inspection locations
- PK: `id` (UUID), FK to organisations(org_id)
- Location: name, site_code, address, postcode, lat/lng
- Type: playground/park/outdoor_gym/muga/skate_park/sports_pitch/mixed
- Contact: name, phone, email
- Access: notes, opening_hours JSONB, parking_notes
- Compliance: install_date, last_refurbishment_date, inspection_frequency_routine_days (7), inspection_frequency_operational_days (90), inspection_frequency_annual_days (365)
- Financial: total_asset_value_gbp, maintenance_contract_ref
- Status: active/archived/temporary_closure

**assets** — Equipment register per site
- PK: `id` (UUID), FK to sites(id) CASCADE, FK to organisations(org_id)
- Unique constraint: (site_id, asset_code)
- Identification: asset_code, asset_type, asset_category (playground/outdoor_gym/furniture/sports/other)
- Manufacturer: name, model, serial_number, install_date, purchase_cost_gbp
- Compliance: compliance_standard, expected_lifespan_years
- Playground-specific: surface_type (wetpour/rubber_mulch/bark_mulch/grass/sand/artificial_grass/tarmac/concrete/other), fall_height_mm, impact_attenuation_required_mm
- Condition tracking: last_inspection_date, last_inspection_condition (good/fair/poor/dangerous), condition_trend (improving/stable/deteriorating)
- Baseline photo columns (Migration 003): baseline_photo_url, baseline_photo_r2_key, baseline_photo_taken_at, baseline_photo_taken_by, baseline_photo_inspection_id, baseline_condition

**inspections** — Inspection records
- PK: `id` (UUID), FK to organisations(org_id), sites(id), users(id)
- Type: routine_visual/operational/annual_main/post_repair/ad_hoc
- Status: draft/review/signed/exported (state machine, DB immutability trigger)
- Risk summary: overall_risk_rating, very_high/high/medium/low counts, total_defects
- Closure: closure_recommended, closure_reason, immediate_action_required
- Signature: signed_by, signed_at, signature_ip_address (immutable once set)
- Export: pdf_url, pdf_generated_at

**inspection_items** — One per asset inspected
- PK: `id` (UUID), FK to inspections(id) CASCADE
- Voice: audio_r2_key, voice_transcript, transcription_method (deepgram/web_speech_api/manual)
- AI: ai_analysis JSONB, ai_model_version, ai_processing_status (pending/processing/completed/failed)
- Assessment: overall_condition, risk_rating, requires_action, action_timeframe
- Inspector review: inspector_confirmed, inspector_notes, inspector_risk_override

**photos** — Inspection evidence
- PK: `id` (UUID), FK to inspection_items(id) CASCADE
- Storage: r2_key, r2_url, thumbnail_r2_key, thumbnail_r2_url
- File: size_bytes, mime_type, width, height
- Type: defect/overview/reference/completion

**defects** — Normalised from AI analysis
- PK: `id` (UUID), FK to inspection_items(id) CASCADE
- Auto-populated by trigger: org_id, site_id, asset_id (from inspection chain)
- Detail: description, defect_category, bs_en_reference
- Severity: very_high/high/medium/low
- Status: open/assigned/in_progress/resolved/verified/deferred/not_actioned
- Source: ai/manual
- Assignment: assigned_to, assigned_at
- Costs: estimated_cost_gbp (TEXT), actual_cost_gbp (NUMERIC)
- Timeline: due_date, started_at, resolved_at, verified_at, verified_by
- Completion: resolution_notes, completion_photo_ids TEXT[]

**audit_log** — All state changes
- org_id, user_id, action, entity_type, entity_id, changes JSONB, ip, user_agent, timestamp

**webhook_events** — Idempotency for Stripe + Clerk
- Composite PK: (id, source), status: processing/completed/failed

### Schema Features
- 22 indexes on key query paths
- 5 RLS tenant isolation policies (sites, assets, inspections, defects, audit_log)
- 31 CHECK constraints matching `enums.ts` values
- 8 triggers: 6 updated_at, 1 signed inspection immutability, 1 auto-populate defect context
- All org_id columns are TEXT (Clerk uses string IDs, not Postgres UUIDs)

### Migrations 002–008 (Feature tables)

| Migration | Table | Feature |
|-----------|-------|---------|
| 002 | `asset_safety_actions` | F2: Make Safe/Close with RLS, status enum, evidence fields |
| 003 | 6 columns on `assets` + `asset_baseline_history` | F5: Baseline photo comparison |
| 004 | `incidents` | F9: 40+ columns, RIDDOR/HSE/police/insurer refs, 7 indexes, RLS |
| 005 | `sealed_exports` | F10: Immutable records, hash chain, signing_key_id, 4 indexes |
| 006 | `email_preferences` + `email_send_log` | F11: Frequency, timezone, unsubscribe token |
| 007 | `normalisation_log` + `normalisation_usage` | F12: Per-field audit trail, monthly token tracking |
| 008 | `site_assignments` | F13: RBAC site-to-inspector assignment, unique constraint |

---

## 7. FRONTEND DETAIL (Batches 1–17 + 20)

### Batches 1–9: Foundation + Security + Site Management
Project scaffold, Tailwind config, design tokens, security hooks (SSRF, CSRF, session timeout), IndexedDB offline store (7 stores), validation framework, DOMPurify sanitisation, Sentry error tracking, site CRUD pages.

### Batch 10: Asset Form + Asset Detail
`AssetForm.tsx` (1,027 lines) — category→type cascade, auto-populated compliance standards, playground-specific fields, full validation, offline-first save. `AssetDetail.tsx` — asset info, inspection history, condition trend.

### Batch 11: Inspection Start Flow
`InspectionStart.tsx` — select inspection type, weather/surface conditions, load asset register, create draft in IndexedDB.

### Batch 12: Voice Capture Service
`voiceCapture.ts` — Web Speech API (live transcript) + MediaRecorder (audio blob) + silence detection + auto-stop + browser capability detection + graceful degradation.

### Batch 13: Photo Capture Service
`photoCapture.ts` — camera access, JPEG compression, thumbnail generation, base64 storage, EXIF GPS extraction.

### Batch 14: Inspection Capture Workflow
`InspectionCapture.tsx` (1,027 lines) — asset stepper with progress dots, voice recording with VU meter, photo capture with thumbnails, checklist per inspection cadence, condition rating buttons, manual notes, per-asset IndexedDB save, resume support.

### Batch 15: Inspection Review + Sign-Off
`InspectionReview.tsx` (765 lines) — 4-card risk summary, 3-card key figures, expandable per-asset results, inspector summary (5000 char), closure recommendation, digital sign-off, immutability enforcement.

### Batch 16: PDF Generation
`pdfGenerator.ts` (1,395 lines) — professional BS EN 1176 report via pdf-lib. Cover page, executive summary, asset results, defect register, sign-off section, "Page X of Y" footers.

### Batch 17: Sync Service
`syncService.ts` (697 lines) — singleton, FIFO queue processing, R2 upload (signed URLs), exponential backoff (2s→60s cap, 3 max attempts), 4xx non-retryable, storage maintenance every 30 min.

### Batch 20: Remaining UI Pages (verified complete)
`InspectionList.tsx`, `DefectTracker.tsx`, `ManagerDashboard.tsx`, `SettingsPage.tsx` — all fully built, zero stubs.

### Domain Configuration
16 asset types: Swing, Slide, Climbing Frame, Roundabout, See-Saw, Spring Rocker, Climbing Net, Monkey Bars, Balance Beam, Multi-Play Unit, Sandpit, Zipline, Pull-Up Bar, Bench, Gate, Fence. Each has inspection points per cadence, risk criteria at 4 severity levels, BS EN defect category references. Standards: BS EN 1176 Parts 1–11, BS EN 1177, BS EN 16630.

### Offline-First Architecture
7 IndexedDB stores: inspections, inspection_items, photos_pending, audio_pending, sync_queue, sites_cache, assets_cache. Background sync via FIFO queue with exponential backoff and dead letter handling. Sites/assets cached with 7-day TTL.

### Security Measures
SSRF (origin-locked), CSRF (auto-inject), DOMPurify (recursive), Sentry PII scrubbing, session timeout (30 min), request throttling (300ms), IndexedDB size guards (photos 10MB/500, audio 50MB/100, text 100KB, queue 1000), signed inspection immutability, ESLint strict.

---

## 8. BACKEND DETAIL (Batch 18 — 34 Cloudflare Worker files)

### Foundation (13 files)
types.ts, shared/errors.ts, shared/logger.ts, shared/validation.ts, shared/pagination.ts, middleware/cors.ts, middleware/guard.ts, middleware/csrf.ts, middleware/rateLimit.ts, services/db.ts, services/audit.ts, services/idempotency.ts, services/r2.ts

### Routes (11 files)
sites.ts, assets.ts, inspections.ts, inspectionItems.ts, uploads.ts, defects.ts, users.ts, org.ts, dashboard.ts, pdf.ts, helpers.ts

### Webhooks (2 files)
webhooks/clerk.ts, webhooks/stripe.ts

### Services (4 files)
services/speechmatics.ts (60+ term custom dictionary, EU batch, en-GB locale, disfluency removal), services/ai.ts (Claude BS EN prompt, 5-level severity, structured JSON output), services/pdf.ts (BS EN inspection schedule table, recommendations), services/r2.ts

### Queues (2 files)
queues/audioProcessor.ts (Speechmatics → Claude → batch defect INSERT with org_id/site_id/inspection_id/asset_id), queues/pdfGenerator.ts (3 efficient queries, single neon() call)

### Config (3 files)
wrangler.toml (R2 bindings, queue bindings, cron triggers, vars), package.json (wrangler v4), tsconfig.json

### Router (1 file)
index.ts — all feature routes, verify endpoint before auth guard (same pattern as webhooks)

---

## 9. FEATURES 1–13 (all built)

### Feature 1: CSV/Excel Defect Export ✅
Server-side Excel (SheetJS), multi-sheet workbook (Defects, Summary by Site, Summary by Risk), risk colour-coding, auto-filters, BS EN refs, photo cross-refs. Client-side offline fallback.

### Feature 2: Make Safe / Close Asset ✅
Formal equipment isolation workflow. Mandatory photo evidence, timestamped audit trail, GPS, offline queuing. Two actions: Make Safe (temporary) and Close Asset (formal removal). Reopening requires separate authorised action with reason.

### Feature 3: Photo Coverage Validation + Cross-Referencing ✅
5 validation rules (3 blocking, 2 warning), sequential numbering (P1, P2…), bidirectional defect↔photo cross-refs. Both PDF generators updated with evidence log sections. Validation blocks sign-off if minimum coverage not met.

### Feature 4: AI Completeness Checks Before Sign-Off ✅
10 deterministic quality checks, A–F grading (100 base, −15 blocking, −5 advisory), canSignOff boolean. No AI API calls — rule-based for speed and reliability. Works offline with local validation fallback.

### Feature 5: Baseline Photo Comparison ✅
Before/after CSS clip-path slider, touch-friendly, condition change detection (Deteriorated/Improved badges). Baseline history audit table. Three UI states: no baseline / baseline only / full comparison.

### Feature 6: Council Procurement Pack ✅ (9 documents)
DPIA (8 sections, 10-risk matrix), DPA (12 clauses, UK GDPR), Security Controls (Cyber Essentials mapping), Technical Spec + SLA (99.5%/99.9%, P1–P4 response), Commercial Terms (£149/£349, 60-day pilot), Training & Migration Guide (10-day timeline), Asset Import Template, Site Import Template, Sample Defect Export (5 sheets, 12 realistic defects).

### Feature 7: Hotlist on Manager Dashboard ✅
Top 20 open VH/H defects with SLA timers, severity badges, made-safe indicators, overdue highlighting (red bg), one-click drill-in. Dashboard completely rewritten with 5 parallel queries. Empty state: green checkmark.

### Feature 8: Longitudinal Risk + Asset History ✅
Condition timeline SVG chart (Good=4→Dangerous=1), repeat defect detection (same BS EN ref 2+), server-computed trend (improving/stable/deteriorating). 4 parallel queries. AssetDetail completely rewritten.

### Feature 9: Incident/Complaint Linking + One-Click Claims Pack ✅
40+ column incidents table (RIDDOR, HSE, police, insurer). 8-section collapsible form. Claims pack: 9 parallel queries, 12-month evidence window, compliance percentage, plain-English verdict. Legal defence tool.

### Feature 10: Tamper-Evident Export Bundles ✅
SHA-256 manifest + HMAC-SHA256 signature + hash chain in zip bundle (fflate). Public verification endpoint (no auth, rate-limited 30/min, zero PII). Signing key versioning (`signing_key_id`) from day one. R2 storage: `sealed-exports/{org_id}/{bundle_id}.zip`.

### Feature 11: Weekly/Monthly Manager Summary Emails ✅
Cloudflare Cron Triggers (Monday 8am weekly, 1st of month monthly). Resend API + React Email TSX templates. Weekly: hotlist, overdue, compliance %. Monthly: trends, inspector activity, condition changes. Token-based unsubscribe. "Nothing to report" threshold. Max 50 emails per cron.

### Feature 12: AI Style Normalisation ✅
Per-field inline normalise button + batch "Normalise All Fields" before sign-off. Claude API with org-specific style config: 3 presets (Formal/Technical/Plain English) + custom guide + before/after examples. Monthly token budget per org. Accept/reject per suggestion. Normalisation history page with usage stats.

### Feature 13: Today's Route Planning ✅
Mapbox GL JS v3 with urgency-coded SVG pins (overdue=red, due_today=orange, this_week=yellow, this_month=blue, not_due=green). RBAC-filtered sites via site_assignments table (admin/manager see all, inspector sees assigned only). Server-side Mapbox Optimization API (≤12 stops) + Directions API (≤25 coords for drag-to-reorder). Geolocation, route summary overlay, responsive layout (side-by-side desktop / toggle mobile).

---

## 10. DEPENDENCIES

### Frontend (`package.json`)
```json
{
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.22.0",
    "react-helmet-async": "^2.0.3",
    "lucide-react": "^0.344.0",
    "dompurify": "^3.0.8",
    "@sentry/react": "^7.100.0",
    "@clerk/clerk-react": "^5.x",
    "idb": "^8.0.0",
    "uuid": "^9.0.0",
    "pdf-lib": "^1.17.1",
    "mapbox-gl": "^3.3.0",
    "react-map-gl": "^7.1.7"
  },
  "devDependencies": {
    "typescript": "^5.3.3",
    "vite": "^5.1.0",
    "@vitejs/plugin-react": "^4.2.1",
    "tailwindcss": "^3.4.1",
    "postcss": "^8.4.35",
    "autoprefixer": "^10.4.17",
    "@types/react": "^18.2.55",
    "@types/react-dom": "^18.2.19",
    "@types/dompurify": "^3.0.5",
    "@types/uuid": "^9.0.7",
    "@types/node": "^20.11.16",
    "@typescript-eslint/eslint-plugin": "^7.0.0",
    "@typescript-eslint/parser": "^7.0.0",
    "eslint": "^8.56.0",
    "vite-plugin-pwa": "^0.17.5"
  }
}
```

### Worker (`workers/package.json`)
Key dependencies: `wrangler` (v4), `@neondatabase/serverless`, `fflate` (zip), `xlsx` (SheetJS), `resend`, `@react-email/components`, `pdf-lib`

---

## 11. INFRASTRUCTURE

### Cloudflare
| Setting | Value |
|---------|-------|
| Account ID | `d5f2a04b6d59db804400d72e297f7561` |
| Worker subdomain | `micks43.workers.dev` |
| Worker URL | `https://inspectvoice-api.micks43.workers.dev` |
| R2 Bucket | `inspectvoice-storage` |
| Queues | `inspectvoice-audio-processing`, `inspectvoice-pdf-generation`, + 2 DLQs |

### Neon
| Setting | Value |
|---------|-------|
| Project | inspectvoice |
| Region | AWS eu-west-2 (London) |
| Schema | All 17 tables deployed ✅ |
| Connection | `DATABASE_URL` secret in Cloudflare Worker |

### Railway
Frontend auto-deploys on push to `main`. Build-time env vars: `VITE_CLERK_PUBLISHABLE_KEY`, `VITE_MAPBOX_TOKEN`, `VITE_API_BASE_URL`.

### CI/CD
- Frontend: Railway auto-deploy on push to `main`
- Worker: Cloudflare GitHub integration auto-deploy on push to `main` (root: `workers/`)
- Database: Manual migration via Neon SQL Editor
- Worker build: `echo 'Typecheck skipped — wrangler handles bundling'` (100+ pre-existing TS errors, esbuild ignores them)

### All Worker Secrets
| Secret | Status |
|--------|--------|
| DATABASE_URL | ✅ |
| CLERK_SECRET_KEY | ✅ |
| CLERK_JWKS_URL | ✅ (`https://set-bullfrog-58.clerk.accounts.dev/.well-known/jwks.json`) |
| CLERK_ISSUER | ✅ (`https://set-bullfrog-58.clerk.accounts.dev`) |
| CLERK_AUTHORIZED_PARTIES | ✅ (`https://inspectvoice-production.up.railway.app`) |
| ANTHROPIC_API_KEY | ✅ |
| SPEECHMATICS_API_KEY | ✅ |
| UPSTASH_REDIS_URL | ✅ |
| UPSTASH_REDIS_TOKEN | ✅ |
| MAPBOX_ACCESS_TOKEN | ✅ |
| MANIFEST_SIGNING_KEY | ⏳ Needed for Feature 10 runtime |
| MANIFEST_SIGNING_KEY_ID | ⏳ Needed for Feature 10 runtime |
| RESEND_API_KEY | ⏳ Needed for Feature 11 runtime |

---

## 12. ROUTING (current)

```
/sign-in                    → Clerk sign-in (public)
/sign-up                    → Clerk sign-up (public)
/                           → Manager Dashboard (F7: Hotlist)
/sites                      → Site list
/sites/new                  → Create site
/sites/:id                  → Site detail + asset register
/sites/:id/edit             → Edit site
/sites/:siteId/assets/new   → Create asset
/sites/:siteId/assets/:id   → Asset detail (F8: condition timeline)
/sites/:siteId/assets/:id/edit → Edit asset
/sites/:siteId/inspections/new → Start inspection
/sites/:siteId/inspections/:id/capture → Capture workflow (F5: baseline)
/sites/:siteId/inspections/:id/review  → Review + sign-off (F4+F12)
/inspections                → Inspection list
/defects                    → Defect tracker
/incidents                  → Incident list (F9)
/incidents/new              → Create incident (F9)
/incidents/:id/edit         → Edit incident (F9)
/route-planner              → Route planning (F13)
/normalisation-history      → Normalisation log (F12)
/settings                   → Settings (F12: normalisation config)
```

---

## 13. DEPLOYMENT STATUS (26 Feb 2026)

### What's Deployed & Working
- ✅ All 17 database tables in Neon
- ✅ Cloudflare Worker with all 13 feature routes
- ✅ Railway frontend with Clerk auth, all pages, green build
- ✅ CI/CD: GitHub auto-deploy for both Worker and frontend
- ✅ Clerk sign-in, JWT v2, guard passing, dashboard loading
- ✅ Mapbox tokens configured (frontend + Worker)

### Pending Deployment
- ⏳ Features 1–5 code files — built, pending commit to repo
- ⏳ Feature 11 + 12 Worker files — built, pending commit
- ⏳ 3 Worker secrets: MANIFEST_SIGNING_KEY, MANIFEST_SIGNING_KEY_ID, RESEND_API_KEY

### Feature Status

| # | Feature | Status |
|---|---------|--------|
| 1 | CSV/Excel Defect Export | ✅ Built |
| 2 | Make Safe / Close Asset | ✅ Built |
| 3 | Photo Coverage Validation | ✅ Built |
| 4 | AI Completeness Checks | ✅ Built |
| 5 | Baseline Photo Comparison | ✅ Built |
| 6 | Council Procurement Pack | ✅ Built |
| 7 | Hotlist Dashboard | ✅ Deployed |
| 8 | Asset History | ✅ Deployed |
| 9 | Incidents + Claims Pack | ✅ Deployed |
| 10 | Tamper-Evident Bundles | ✅ Deployed |
| 11 | Manager Summary Emails | ✅ Built, pending secrets |
| 12 | AI Style Normalisation | ✅ Built, pending secrets |
| 13 | Route Planning | ✅ Deployed |

---

## 14. WHAT'S NEXT

1. **Configure remaining secrets** — MANIFEST_SIGNING_KEY + KEY_ID, RESEND_API_KEY
2. **Commit Features 1–5** — wire into codebase
3. **Commit Feature 11 + 12 Worker files** — push for auto-deploy
4. **Steps 10.11–10.12** — sealed export options on InspectionReview + IncidentForm
5. **Site assignment admin UI** — manager page to assign inspectors to sites (data model ready)
6. **Fix pre-existing TS errors** — 100+ across Worker codebase, then restore `tsc --noEmit` to build
7. **Seed test data** — test site + inspection for end-to-end verification
8. **Customise procurement pack** — placeholder fields, pricing, solicitor review of DPA
9. **Sample PDF report** — redacted sample for procurement pack
10. **Stripe integration** — payment webhooks, plan management
11. **Domain** — `inspectvoice.co.uk` (zone exists in Cloudflare, no Worker route yet)
12. **Cyber Essentials certification** — Q3 2026, controls mapped
13. **Pilot outreach** — 60-day free pilot offer to councils

---

## 15. KEY LEARNINGS

1. **Vite env vars are build-time** — changing `VITE_*` requires redeploy
2. **Clerk v2 JWT** — org claims in nested `o` object, not flat `org_id`/`org_role`
3. **OrgGate required** — without active org, JWT lacks org_id, guard rejects
4. **Auth token bridge** — module-level getter/setter bridges React hooks to plain functions
5. **Cloudflare root directory** — must point to `workers/` subfolder
6. **wrangler.toml `[vars]` override dashboard** — deploying overwrites dashboard-set env vars
7. **esbuild vs tsc** — esbuild only catches import/export mismatches, not type errors
8. **500 vs 401 vs 403** — 500 after auth changes proves guard working, error is downstream
9. **Sealed exports immutable** — no updated_at column or trigger
10. **Signing key versioning from day one** — prevents rotation nightmares
11. **TypeScript strict array indexing** — `array[index]` returns `T | undefined`
12. **react-map-gl Map clashes with built-in Map** — rename to MapGL
13. **Phantom `@types` packages** — `"types": []` in tsconfig prevents auto-discovery
14. **Mapbox Optimization API ≤12 stops** — design UX around this from day one
15. **Speechmatics replaced Deepgram** — EU batch API, enhanced model, 60+ term custom dictionary
16. **Migration schema alignment** — table names (`organisations` not `orgs`), TEXT not UUID for Clerk IDs

---

## 16. HOW TO CONTINUE IN A NEW CHAT

Upload this document. Then say: *"Continue InspectVoice build. Here's my master reference. [Task description]."*

If modifying existing files, upload the current version from GitHub before editing — never work from stale copies. Claude will ask for what it needs.

Mick commits via GitHub web interface, max 3 files at a time. Every file must be complete, copy-paste ready, production-ready first time.
